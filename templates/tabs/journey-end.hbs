<section class="journey-stage stage-journey-end {{#if (eq tab "journeyEnd")}}active{{/if}}" data-tab="journeyEnd">
  <header class="stage-header">
    <h2><i class="fas fa-flag-checkered"></i> Journey's End</h2>
    {{#if (eq session.outcome "arrived")}}
    <p class="stage-description success">
      <i class="fas fa-check-circle"></i> The party has arrived at <strong>{{session.destination}}</strong>!
    </p>
    {{else}}
    <p class="stage-description warning">
      <i class="fas fa-exclamation-triangle"></i> The journey was abandoned.
    </p>
    {{/if}}
  </header>

  {{!-- Journey Summary --}}
  <div class="journey-summary-section">
    <h3><i class="fas fa-scroll"></i> Journey Summary</h3>
    <div class="summary-grid">
      <div class="summary-item">
        <span class="label">Route</span>
        <span class="value">{{session.origin}} to {{session.destination}}</span>
      </div>
      <div class="summary-item">
        <span class="label">Distance</span>
        <span class="value">{{lookup (lookup distances session.distance) "name"}}</span>
      </div>
      <div class="summary-item">
        <span class="label">Encounters</span>
        <span class="value">{{session.resolvedEncounterCount}} / {{totalEncounters}}</span>
      </div>
      <div class="summary-item">
        <span class="label">Final DC</span>
        <span class="value">{{difficulty}}</span>
      </div>
    </div>
  </div>

  {{!-- Arrival Roll --}}
  {{#if (eq session.outcome "arrived")}}
  <div class="arrival-roll-section">
    <h3><i class="fas fa-dice"></i> Arrival Circumstances</h3>
    {{#if session.arrivalResult}}
    <div class="arrival-result">
      <div class="dice-result">
        <span class="dice">Result: {{session.arrivalResult}}</span>
      </div>
      <div class="arrival-details">
        {{!-- Result will be shown via chat message --}}
        <p>Arrival roll complete. Check chat for details.</p>
      </div>
    </div>
    {{else}}
    <div class="arrival-roll-prompt">
      <p>The Sentry rolls Xd12 (X = Wisdom modifier, minimum 1) and takes the highest result.</p>
      <button type="button" class="roll-btn" data-action="rollArrival">
        <i class="fas fa-dice"></i> Roll Arrival
      </button>
    </div>
    {{/if}}
  </div>
  {{/if}}

  {{!-- Exhaustion Saves --}}
  <div class="exhaustion-section">
    <h3><i class="fas fa-tired"></i> End of Journey Exhaustion</h3>
    <p class="section-hint">
      Each party member must make a Fortitude save (DC {{difficulty}}), adding the Quartermaster's Strength or Intelligence modifier to the roll.
      Success grants temporary HP equal to level. Failure causes 1 level of exhaustion.
    </p>

    <div class="exhaustion-saves-grid">
      {{#each session.partyMembers}}
      <div class="exhaustion-save-card">
        <div class="actor-info">
          {{#with (lookup ../actors actorId)}}
          <img src="{{img}}" alt="{{name}}">
          <span class="actor-name">{{name}}</span>
          {{/with}}
        </div>

        {{#with (lookup ../session.endOfJourneySaves @index)}}
        <div class="save-result {{#if success}}success{{else}}failure{{/if}}">
          {{#if success}}
          <i class="fas fa-check-circle"></i> Saved ({{roll}})
          {{else}}
          <i class="fas fa-times-circle"></i> Failed ({{roll}})
          {{/if}}
        </div>
        {{else}}
        <button type="button"
                class="roll-save-btn"
                data-action="rollExhaustionSave"
                data-actor-id="{{actorId}}">
          <i class="fas fa-dice-d20"></i> Roll Save
        </button>
        {{/with}}
      </div>
      {{/each}}
    </div>
  </div>

  {{!-- Party Status --}}
  <div class="party-status-section">
    <h3><i class="fas fa-users"></i> Party Status</h3>
    <div class="party-status-grid">
      {{#each session.partyMembers}}
      <div class="party-member-status">
        {{#with (lookup ../actors actorId)}}
        <div class="member-header">
          <img src="{{img}}" alt="{{name}}">
          <span>{{name}}</span>
        </div>
        <div class="member-conditions">
          <span class="condition role">{{../role}}</span>
        </div>
        {{/with}}
      </div>
      {{/each}}
    </div>
  </div>

  <footer class="stage-footer">
    <button type="button" class="send-summary-btn" data-action="sendEndSummary">
      <i class="fas fa-paper-plane"></i> Send Summary to Chat
    </button>
    <button type="button" class="new-journey-btn confirm-btn" data-action="newJourney">
      <i class="fas fa-plus"></i> Start New Journey
    </button>
  </footer>
</section>
