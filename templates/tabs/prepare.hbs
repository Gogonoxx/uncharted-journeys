<section class="journey-stage stage-prepare {{#if (eq tab "prepare")}}active{{/if}}" data-tab="prepare">
  <header class="stage-header">
    <h2><i class="fas fa-tasks"></i> Prepare for the Journey</h2>
    <p class="stage-description">Assign party roles, make preparations, and complete group checks.</p>
    <div class="difficulty-badge">
      <span class="label">Current DC:</span>
      <span class="value">{{difficulty}}</span>
    </div>
  </header>

  {{!-- Role Assignments --}}
  <div class="role-assignments">
    <h3><i class="fas fa-users-cog"></i> Assign Roles</h3>
    <p class="section-hint">Select an actor for each role, then click "Assign All Roles".</p>

    <div class="roles-grid">
      {{#each roles}}
      <div class="role-card role-assignment" data-role="{{id}}">
        <div class="role-header">
          <i class="fas {{icon}}"></i>
          <h4>{{name}}</h4>
        </div>
        <div class="role-skills">
          <span class="primary-skill" data-tooltip="Primary Skill">{{primarySkill}}</span>
          <span class="alt-skill" data-tooltip="Alternative Skill">{{alternativeSkill}}</span>
        </div>
        <div class="role-ability">
          <small>{{ability.description}}</small>
        </div>
        <div class="role-assignment-controls">
          <select name="actor-{{id}}" class="actor-select" data-role="{{id}}">
            <option value="">-- Select Actor --</option>
            {{#each ../actors}}
            {{#with (lookup ../../partyMembersByRole ../id)}}
            <option value="{{../id}}" {{#if (eq ../id actorId)}}selected{{/if}}>
              {{../name}}
            </option>
            {{else}}
            <option value="{{id}}">
              {{name}}
            </option>
            {{/with}}
            {{/each}}
          </select>
        </div>

        {{!-- Show assigned member status --}}
        {{#with (lookup ../partyMembersByRole id)}}
        <div class="member-status assigned">
          <i class="fas fa-user-check"></i>
          <span>{{lookup (lookup ../../actorsById actorId) "name"}}</span>
        </div>
        {{/with}}
      </div>
      {{/each}}
    </div>

    <div class="assign-all-controls">
      <button type="button" class="assign-all-btn" data-action="assignAllRoles">
        <i class="fas fa-users"></i> Assign All Roles
      </button>
    </div>
  </div>

  {{!-- Preparations --}}
  <div class="preparations-section">
    <h3><i class="fas fa-clipboard-list"></i> Preparations</h3>
    <p class="section-hint">Each role may select and attempt one preparation. DC: {{difficulty}}</p>

    <div class="prep-info-controls">
      <button type="button" class="send-prep-list-btn" data-action="sendPreparationList">
        <i class="fas fa-list"></i> Show Preparations in Chat
      </button>
    </div>

    {{#each partyMembersWithNames}}
    <div class="preparation-row" data-role="{{role}}">
      <div class="prep-actor">
        <strong>{{actorName}}</strong>
        <span class="prep-role">({{roleName}})</span>
      </div>
      <div class="prep-select">
        <select class="preparation-select" data-role="{{role}}">
          <option value="">-- No Preparation --</option>
          {{#each ../preparations}}
          <option value="{{id}}" {{#if (eq id ../preparationId)}}selected{{/if}}>
            {{name}} ({{skillSlug}})
          </option>
          {{/each}}
        </select>
      </div>
      <div class="prep-actions">
        <button type="button"
                class="roll-prep-btn"
                data-action="rollPreparation"
                data-role="{{role}}"
                {{#unless preparationId}}disabled{{/unless}}
                {{#if (ne preparationResult "pending")}}disabled{{/if}}>
          <i class="fas fa-dice-d20"></i> Roll
        </button>
      </div>
      <div class="prep-result {{preparationResult}}">
        {{#if (eq preparationResult "success")}}
        <i class="fas fa-check-circle"></i> Success
        {{else if (eq preparationResult "failure")}}
        <i class="fas fa-times-circle"></i> Failure
        {{else}}
        <i class="fas fa-clock"></i> Pending
        {{/if}}
      </div>
    </div>
    {{/each}}
  </div>

  {{!-- Rest Step --}}
  <div class="rest-section">
    <h3><i class="fas fa-bed"></i> Rest</h3>
    <p class="section-hint">Before beginning the journey, each party member may rest or stay up to attempt another preparation.</p>
    <div class="rest-controls">
      <button type="button" class="send-rest-btn" data-action="sendRestOptions">
        <i class="fas fa-moon"></i> Send Rest Options to Chat
      </button>
    </div>
  </div>

  {{!-- Group Checks --}}
  <div class="group-checks-section">
    <h3><i class="fas fa-users"></i> Group Journey Checks</h3>
    <p class="section-hint">Each party member picks a skill and rolls against DC {{difficulty}}. Mark success or failure after rolling.</p>

    <div class="group-check-results">
      {{#each partyMembersWithNames}}
      <div class="check-result-row" data-role="{{role}}">
        <div class="check-actor-info">
          <span class="check-actor">{{actorName}}</span>
        </div>
        <div class="check-skill-buttons">
          <button type="button"
                  class="skill-check-btn"
                  data-action="sendSkillCheck"
                  data-role="{{role}}"
                  data-skill="{{primarySkill}}"
                  {{#if (ne groupCheckResult "pending")}}disabled{{/if}}>
            <i class="fas fa-dice-d20"></i> {{primarySkill}}
          </button>
          <button type="button"
                  class="skill-check-btn alt"
                  data-action="sendSkillCheck"
                  data-role="{{role}}"
                  data-skill="{{alternativeSkill}}"
                  {{#if (ne groupCheckResult "pending")}}disabled{{/if}}>
            <i class="fas fa-dice-d20"></i> {{alternativeSkill}}
          </button>
        </div>
        <div class="check-result-buttons">
          <button type="button"
                  class="success-btn {{#if (eq groupCheckResult "success")}}active{{/if}}"
                  data-action="setGroupCheckResult"
                  data-role="{{role}}"
                  data-result="success">
            <i class="fas fa-check"></i>
          </button>
          <button type="button"
                  class="failure-btn {{#if (eq groupCheckResult "failure")}}active{{/if}}"
                  data-action="setGroupCheckResult"
                  data-role="{{role}}"
                  data-result="failure">
            <i class="fas fa-times"></i>
          </button>
        </div>
      </div>
      {{/each}}
    </div>

    <div class="group-check-summary">
      <p>
        <strong>Passed:</strong> {{passedGroupChecks}} / {{partyMembersWithNames.length}}
        {{#if (gte failedGroupChecks 2)}}
        <span class="warning"><i class="fas fa-exclamation-triangle"></i> +1 encounter for 2+ failures</span>
        {{/if}}
      </p>
    </div>
  </div>

  <footer class="stage-footer">
    <button type="button"
            class="confirm-btn"
            data-action="confirmPreparation"
            {{#unless allGroupChecksComplete}}disabled{{/unless}}>
      <i class="fas fa-hiking"></i> Begin Journey
    </button>
    {{#unless allGroupChecksComplete}}
    <p class="footer-hint">Complete all group checks to proceed.</p>
    {{/unless}}
  </footer>
</section>
