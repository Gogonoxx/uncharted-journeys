<section class="journey-stage stage-journey {{#if (eq tab "journey")}}active{{/if}}" data-tab="journey">
  <header class="stage-header">
    <h2><i class="fas fa-hiking"></i> Die Reise</h2>
    <p class="stage-description">
      Von <strong>{{session.origin}}</strong> nach <strong>{{session.destination}}</strong>
    </p>
    <div class="journey-stats">
      <span class="stat"><i class="fas fa-bullseye"></i> DC {{difficulty}}</span>
      <span class="stat"><i class="fas fa-route"></i> {{session.distance}}</span>
      <span class="stat highlight"><i class="fas fa-map-marker-alt"></i> {{encounterCount}} Encounters</span>
    </div>
  </header>

  {{!-- ===================== --}}
  {{!-- BIOME NODES SECTION --}}
  {{!-- ===================== --}}
  <div class="biome-nodes-section">
    <h3><i class="fas fa-map-marker-alt"></i> Reise-Orte</h3>

    <p class="section-hint">
      F칲ge f칲r jedes Biom die gew칲nschten Orte hinzu. Die Farbe bestimmt den Encounter-Pool:
    </p>

    <div class="biome-legend">
      <span class="legend-item green"><i class="fas fa-shield-alt"></i> Sicher (Social)</span>
      <span class="legend-item yellow"><i class="fas fa-random"></i> Gemischt (Alle)</span>
      <span class="legend-item red"><i class="fas fa-skull"></i> Gef칛hrlich (Combat)</span>
    </div>

    {{!-- Biome list with nodes --}}
    <div class="biome-list">
      {{#each biomeNodes as |biome|}}
      <div class="biome-section" data-biome-id="{{biome.id}}">
        <div class="biome-header">
          <span class="biome-name">
            <i class="fas fa-mountain"></i> {{biome.name}}
          </span>
          <div class="biome-add-buttons">
            <button type="button" class="add-node-btn green" data-action="addBiomeNode" data-biome="{{biome.id}}" data-node-type="green" title="Sicheren Ort hinzuf칲gen">
              <i class="fas fa-plus"></i> 游릭
            </button>
            <button type="button" class="add-node-btn yellow" data-action="addBiomeNode" data-biome="{{biome.id}}" data-node-type="yellow" title="Gemischten Ort hinzuf칲gen">
              <i class="fas fa-plus"></i> 游리
            </button>
            <button type="button" class="add-node-btn red" data-action="addBiomeNode" data-biome="{{biome.id}}" data-node-type="red" title="Gef칛hrlichen Ort hinzuf칲gen">
              <i class="fas fa-plus"></i> 游댮
            </button>
          </div>
        </div>

        {{#if biome.nodes.length}}
        <div class="biome-nodes">
          {{#each biome.nodes as |node|}}
          <div class="biome-node {{node.type}} {{#if node.resolved}}resolved{{/if}}" data-node-id="{{node.id}}">
            <span class="node-color-indicator {{node.type}}">
              {{#if (eq node.type "green")}}游릭{{/if}}
              {{#if (eq node.type "yellow")}}游리{{/if}}
              {{#if (eq node.type "red")}}游댮{{/if}}
            </span>
            <input type="text"
                   class="node-name-input"
                   value="{{node.name}}"
                   data-action="renameBiomeNode"
                   data-node-id="{{node.id}}"
                   placeholder="Ortsname eingeben..."
                   {{#if node.resolved}}disabled{{/if}}>
            <div class="node-actions">
              {{#unless node.resolved}}
              <button type="button" class="roll-encounter-btn" data-action="rollBiomeNodeEncounter" data-node-id="{{node.id}}" title="Encounter w칲rfeln">
                <i class="fas fa-dice-d20"></i>
              </button>
              <button type="button" class="remove-node-btn" data-action="removeBiomeNode" data-node-id="{{node.id}}" title="Ort entfernen">
                <i class="fas fa-times"></i>
              </button>
              {{else}}
              <span class="resolved-badge"><i class="fas fa-check-circle"></i></span>
              {{/unless}}
            </div>
          </div>
          {{/each}}
        </div>
        {{else}}
        <p class="no-nodes-hint">Noch keine Orte in diesem Biom. Klicke auf +游릭/游리/游댮 um einen hinzuzuf칲gen.</p>
        {{/if}}
      </div>
      {{/each}}
    </div>

    {{!-- Summary --}}
    {{#if totalBiomeNodeCount}}
    <div class="nodes-summary">
      <span class="summary-count">
        <strong>{{resolvedBiomeNodeCount}}</strong> / <strong>{{totalBiomeNodeCount}}</strong> Orte abgeschlossen
      </span>
      <span class="summary-target">
        (Ziel: {{encounterCount}} Encounters)
      </span>
    </div>
    {{/if}}
  </div>

  {{!-- ========================= --}}
  {{!-- ROLE ABILITIES (behalten) --}}
  {{!-- ========================= --}}
  <div class="role-abilities-section">
    <h3><i class="fas fa-star"></i> Rollen-F칛higkeiten</h3>
    <div class="role-ability-grid">
      {{#each session.partyMembers}}
      {{#with (lookup ../roles role)}}
      <div class="role-ability-card {{#if ../roleAbilityUsed}}used{{/if}}">
        <div class="ability-header">
          <i class="fas {{icon}}"></i>
          <span>{{name}}</span>
        </div>
        <p class="ability-text">{{ability.description}}</p>
        <button type="button"
                class="use-ability-btn"
                data-action="useRoleAbility"
                data-role="{{../role}}"
                {{#if ../roleAbilityUsed}}disabled{{/if}}>
          {{#if ../roleAbilityUsed}}
          <i class="fas fa-check"></i> Verwendet
          {{else}}
          <i class="fas fa-bolt"></i> F칛higkeit nutzen
          {{/if}}
        </button>
      </div>
      {{/with}}
      {{/each}}
    </div>
  </div>

  {{!-- ==================== --}}
  {{!-- NAVIGATION (behalten) --}}
  {{!-- ==================== --}}
  <footer class="stage-footer">
    {{!-- Complete Journey - always visible, GM decides when journey is done --}}
    <button type="button" class="confirm-btn" data-action="completeJourney">
      <i class="fas fa-flag-checkered"></i> Reise abschlie른n
    </button>

    <button type="button" class="abandon-btn danger" data-action="abandonJourney">
      <i class="fas fa-times"></i> Reise abbrechen
    </button>
  </footer>
</section>
